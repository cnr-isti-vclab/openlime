<!doctype html>
<html>
<head>
	<title>OpenLime</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta charset="UTF-8" />

	<link rel="stylesheet" href="skin.css" />
	<style>
		html,
		body {
		  margin: 0px;
		  padding: 0px;
		  height: 100%;
		}
	
		.container {
		  height: 100%;
		  position:relative;
		}
		#openlime {
			width: 100%;
			height: 100%;
		}
	
		#openlime>canvas {
		  width: 100%;
		  height: 100%;
		  overflow: hidden;
		  background-color:black;
		  /* this is important, it would cause firefox flickering! */
		}
	
		.openlime-overlay, .openlime-svgoverlay {
		  position:absolute;
		  top:0px;
		  width:100%;
		  height:100%;
		}
		#logos {
			position:absolute;
			top:0px;
			right:0px;
			z-index:20;
		}
		#logos img {
			height:48px;
			margin-right:8px;
		}
		#feedback a {
			color:white;
		}
		.openlime-markers.active .openlime-button-off {
			visibility:visible !important;
		}
		.openlime-markers .openlime-button-off {
			visibility:hidden !important;
		}
		#navigator {
			position:absolute;
			bottom: 20px;
			width: 200px;
			left:calc(50% - 100px);
			background-color: rgba(32, 32, 32, 0.9);
			padding:4px;
			border-radius: 12px;
			display: flex;
			color:white;
			display:flex;
			justify-content:space-between;
		}
		#navigator svg {
			cursor:pointer;
			fill:none;
			stroke: white;
			stroke-width:3px;
			height:24px;
			width:24px;
		}
		#navigator p {
			line-height:24px;
			margin:0px;
			font-family:arial;
		}
	  </style>
	
</head>
<body>

<div class="container">
	<div id="openlime">
	</div>
	<div id="logos">
		<a href="https://www.musee-histoire-marseille-voie-historique.fr/"><img src="img/marseille.svg"/></a>
		<a href="https://mercurioimaging.com/"><img src="img/mercurio.svg"/></a>
		<a href="https://vcg.isti.cnr.it"><img src="img/vcg.svg"/></a>
	</div>
	<div id="navigator">
		<svg class="prev" xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d="M20 4 L8 12 L20 20"></path></svg>
		<p></p>
		<svg class="next" xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d="M4 4 L16 12 L4 20"></path></svg>
	</div>
	<div id="feedback">
		<h2> A fancy title</h2>
		<p>Some text about the feedback</p>
		<p>And a <a href="">link to the google form</a></p>
	</div>
</div>

<script src="openlime.js"></script>


<script>

let lime = new OpenLIME.OpenLIME('#openlime', { canvas: { preserveDrawingBuffer: false} });

let layer0 = new OpenLIME.Layer({ 
	label: '4',
	layout: 'itarzoom', 
	type:'rti',
	url: 'assets/rti/hsh/info.json',
//	url: 'Data/ptm_lowdef_mask/info.json',
//	url: '../mhm/Data/ptm_itarzoom/info.json',
	normals: false
});

lime.canvas.addLayer('coin', layer0);

let count = 0;

function buildPin(anno, cx, cy) {
	let pin = `
<svg xmlns='http://www.w3.org/2000/svg' x='${cx}' y='${cy}' width="4%" height="4%" viewBox="-2 -2 20 20">

	<path d='M 0,0 C 0,0 4,0 8,0 12,0 16,4 16,8 16,12 12,16 8,16 4,16 0,12 0,8 0,4 0,0 0,0 Z'/>
	<text x='7' y='8'>${count}</text>
</svg>`;

	let parser = new DOMParser();
	let svg = parser.parseFromString(pin, "image/svg+xml").documentElement; //"text/html").body.childNodes[0];
	count++;
	return svg;
}
	

let annotations = new OpenLIME.SvgAnnotationLayer({ 
	label: 'Annotations',
	layout: layer0.layout,
	annotations: 'fetch.php',
	/*lod: [ 
		{ min: 3.5, max: 100, type: 'vector' }
	], */
	style:` 
		path { fill:none; stroke-width:2; stroke:#666; vector-effect:non-scaling-stroke; pointer-events:all; }
		path:hover { cursor:pointer; stroke:#000; }
		:focus, .selected { stroke:#000 !important; stroke-width:3; }
		`,
	infoTemplate: (anno) => { return `
		<h3>${anno.label}</h3>
		<p>${anno.description}</p>
		`; },

	classes: {
		'': { stroke: '#000', label: '' },
		'class1': { stroke: '#770', label: 'A' },
		'class2': { stroke: '#707', label: 'B' },
		'class3': { stroke: '#777', label: 'C' },
		'class4': { stroke: '#070', label: 'D' },
		'class5': { stroke: '#007', label: 'E' },
		'class6': { stroke: '#077', label: 'F' },
	},
	annotationUpdate: (anno, transform) => {
		anno.selector.elements.forEach((e) => e.setAttribute('opacity', Math.max(0, 0.5*(transform.z - 2)) ))
	}
}); 

lime.canvas.addLayer('anno', annotations); //here the overlayelement created and attached to layer

let pois = new OpenLIME.SvgAnnotationLayer({
	label: 'Points of interest',
	layout: layer0.layout,
	annotations: 'poi.json',
	lod: [ 
		{ min: 0, max: 3.6, type: 'vector' }
	],
	style: `
		path { cursor:pointer; fill: rgba(32, 32, 32, 0.8); stroke: #aaa; stroke-width:2px; vector-effect:non-scaling-stroke; }
		text { cursor:pointer; user-select: none; font-family:arial; font-size:8px; fill:#fff; alignment-baseline:middle; text-anchor:middle; }
		`,

	onClick: (anno) => { zoomToAnnotation(anno); }
});

lime.canvas.addLayer('pins', pois); //here the overlayelement created and attached to layer

lime.camera.maxFixedZoom = 4;

OpenLIME.Skin.setUrl('skin.svg');



let ui = new OpenLIME.UIBasic(lime, { showLightDirections: true });
let { help, home, fullscreen, light } = ui.actions

help.display = true;
help.html = `
<h2>Welcome to the project<br/>
	"a new light on the block of de l'Alcazar"</h2>
<p>Si la lumière est éteinte, cliquez et déplacez pour déplacer l'image</p>
<p>Si la lumière est allumée, cliquez et déplacez pour déplacer la lumière
Cliquez sur la lumière pour changer sa fonction</p>

<p>Cliquez sur l'icone <b>Calques</b> pour afficher les annotations
Selectionnez une annotations et activez l'outil "dessin" en cliquant dessus.</p>
<p>Commencez un dessin libre en cliquant sur une petite distance, vous pouvez le continuer en
cliquand point par point. Pour commencer une nouvelle trace, il faut garder cliqué et bouger
légèrmeent la souris.</p>

<p>En mode <b>Annotation</b>, la combinaison <i>Majuscule</i> + clic et déplacement fait bouger la lumière
La combinaison <i>Alt</i> + clic et déplacement fait bouger l'image
Le bouton annuler permet d'annuler, il est possible aussi de faire <i>Ctrl</i>+z</p>
`;
let feedback = { title: 'Feedback', display: true, task: (event) => { 
	feedbackDialog.toggle();
} };

let markers = { title: 'Show annotations', display: true, task: (event) => { 
	let button = markers.element.querySelector('.openlime-button');
	let visible = !annotations.visible;
	annotations.setVisible(visible);
	pois.setVisible(visible);
	button.classList.toggle('active', !annotations.visible);
} };

ui.actions = { feedback, markers, help, home, fullscreen, light };



let openlime = document.getElementById('openlime');
let feedbackDialog = new OpenLIME.UIDialog(openlime, { modal: true} );
feedbackDialog.setContent(document.getElementById('feedback'));
feedbackDialog.hide();


function zoomToAnnotation(anno) {
	let cam = anno.camera;
	lime.camera.setPosition(1000, cam.x, cam.y, cam.z, 0, 'ease-out');

	let light = anno.light;
	layer0.setLight([light.x, light.y], 1000);
	navigator.querySelector('p').textContent = `${currentAnno + 1} ${anno.label}`;

	annotations.clearSelected();
	for(let id of anno.target) {
		let targetAnno = annotations.getAnnotationById(id)
		annotations.setSelected(targetAnno);
	}
	ui.info.setContent(`<h2>${anno.label}</h2><p>${anno.description}</p>`);
	ui.info.show();
	return true;
}

let currentAnno = -1;
function nextAnnotation(e) {
	if(currentAnno >= pins.length -1)
		return false;
	currentAnno++;
	zoomToAnnotation(pins[currentAnno]);

	e.preventDefault();
	e.stopPropagation();
}

function prevAnnotation(e) {
	
	if(currentAnno <= 0)
		return false;
	currentAnno--;
	zoomToAnnotation(pins[currentAnno]);

	e.preventDefault();
	e.stopPropagation();
}


let navigator = document.getElementById('navigator');


let pins = null;
lime.canvas.addEvent('ready', 
	() => {
		let logos = document.getElementById('logos');

		lime.camera.deltaZoom(500, 1.1, 0, 0);
		layer0.setLight([-0.5, 0.5], 500);
		setTimeout(() => { 
			ui.toggleHelp(ui.actions.help); 

		}, 700);	});

pois.addEvent('loaded', () => { 
	pins = Object.values(pois.annotations);
	navigator.querySelector('.prev').addEventListener('click', prevAnnotation);
	navigator.querySelector('.next').addEventListener('click', nextAnnotation);
});

</script>
</body>
</html>
