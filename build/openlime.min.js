!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).OpenLIME={})}(this,(function(e){"use strict";class r{constructor(t,e,i,r,s){if(null!==t)this.x=t||0,this.y=e||0,this.z=i||1,this.a=r||0,this.t=s||0;else{let t={x:0,y:0,z:1,a:0,t:0};Object.assing(this,t())}}copy(){return Object.assign({},this)}interpolate(t,e,i){if(i<t.t)return t;if(i>e.t)return e;let r=e.t-t.t;if(r<1e-4)return e;let s=(i-t.t)/r,a=(e.t-r)/r;for(let i of["x","y","z","a"])this[i]=a*t[i]+s*e[i];this.t=i}}class s{constructor(t){Object.assign(this,{bounded:!0,maxZoom:4,minZoom:"full"}),Object.assign(this,t),this.target=new r(this.target),this.source=this.target.copy(),console.log(this.target,this.source)}getCurrentTransform(t){if(t<this.target.source)return this.source;if(t>this.target.t)return this.target;let e=new r;return e.interpolate(this.source,this.target,t),e}}class a{constructor(t,e,r){Object.assign(this,{preserveDrawingBuffer:!1,viewport:[0,0,0,0],gl:null,layers:{}});if(r){Object.assign(this,r);for(let t in this.layers)this.layers[i]=new Layer(t,this.layers[i])}this.camera=new s(this.camera),this.initElement(t)}resize(t,e){this.canvas.width=t,this.canvas.height=e,this.prefetch(),this.redraw()}initElement(t){if(!t)throw"Missing element parameter";if("string"==typeof t&&!(t=document.querySelector(t)))throw"Could not find dom element.";if(!t.tagName)throw"Element is not a DOM element";if("CANVAS"!=t.tagName)throw"Element is not a canvas element";let e={antialias:!1,depth:!1,preserveDrawingBuffer:this.preserveDrawingBuffer};if(this.gl=this.gl||t.getContext("webgl2",e)||t.getContext("webgl",e)||t.getContext("experimental-webgl",e),!this.gl)throw"Could not create a WebGL context";this.canvas=t}setPosition(t,e,i,r,s){}draw(t){let e=this.camera.getCurrentTransform(t);this.prefetch(e);let i=Object.values(this.layers).sort(((t,e)=>t.zindex-e.zindex));for(let t of i)i.visible&&i.draw(e);return e.t==this.camera.target.t}prefetch(t){for(let e in this.layers)this.layers[e].prefetch(t,this.viewport)}}class o{constructor(t){Object.assign(this,{type:"vec3",colorSpace:"linear",attribute:"kd"}),Object.assign(this,t)}}class h{constructor(t,e){this.id=t,Object.assign(this,{samplers:[],uniforms:{},name:"",body:"",program:null})}createProgram(e){let i=e.createShader(e.VERTEX_SHADER);e.shaderSource(vertShader,this.vertShaderSrc(100));let r=e.compileShader(i);if(!r)throw console.log(e.getShaderInfoLog(i)),"Failed vertex shader compilation: see console log and ask for support.";let s=e.createShader(e.FRAGMENT_SHADER);e.shaderSource(s,this.fragShaderSrc()),e.compileShader(s);let a=e.createProgram();if(r=e.getShaderParameter(s,e.COMPILE_STATUS),!r)throw console.log(e.getShaderInfoLog(t.fragShader)),"Failed fragment shader compilation: see console log and ask for support.";e.attachShader(a,i),e.attachShader(a,s),e.linkProgram(a),this.program=a}vertShaderSrc(t){return t||(t=100),`\n#version ${t}\nprecision highp float; \nprecision highp int; \n\nuniform mat4 u_matrix;\nattribute vec4 a_position;\nattribute vec2 a_texCoord;\n\nvarying vec2 v_texCoord;\n\nvoid main() {\n\tgl_Position = u_matrix * a_position;\n\tv_texCoord = a_texCoord;\n}`}fragShaderSrc(){let t=this.header();return t+=this.attributes(),t+=`\nvec4 ${name}() {\n${this.body}\n}\n`,t+=this.main(),t}header(){let t="\n\n#ifdef GL_ES\nprecision highp float;\nprecision highp int;\n#endif\n\nvarying vec2 v_texcoord;\n\n";return t+=uniformsHeader(),t}uniformsHeader(){return""}main(){return`\nvoid main() {\n\tvec4 color = ${this.id}();\n\tcolor.a *= opacity;\n\tfragColor = color;\n}\n`}}class n{constructor(t){if(Object.assign(this,{transform:new r,visible:!0,zindex:0,opacity:1,layout:null,rasters:[],controls:{},shaders:{},layout:"image",shader:null,prefetchBorder:1,mipmapBias:.5,maxRequest:4,update:[],tiles:[],queued:[],requested:{}}),Object.assign(this,t),this.type){if(this.type in this.types)return t.type=null,this.types[this.type](t);throw"Layer type: "+this.type+" has not been loaded"}this.rasters=this.rasters.map((t=>new o(t))),"object"!=typeof this.layout&&this.rasters.length&&(this.layout=new Layout(this.rasters[0],this.layout)),this.shader&&(this.shader=new h(this.shader))}setVisible(t){this.visible=t,this.emit("update")}setZindex(t){this.zindex=t,this.emit("update")}draw(t,e){if("ready"==this.status){if(!this.shader)throw"Shader not specified!";this.prepareWebGL(e),drawTile(e,t,0,0,0)}}drawTile(t,e,i,r,s){var a=this.layout.index(i,r,s);let o=this.tiles[a];if(0!=o.missing)throw"Attempt to draw tile still missing textures";updateTileBuffers(t,coords,tcoords);for(var h=0;h<this.shader.samplers;h++){let e=this.shader.samplers[h];t.activeTexture(t.TEXTURE0+h),t.bindTexture(t.TEXTURE_2D,o.tex[e])}t.drawElements(t.TRIANGLES,6,t.UNSIGNED_SHORT,0)}updateTileBuffers(){gl.bindBuffer(gl.ARRAY_BUFFER,t.vbuffer),gl.bufferData(gl.ARRAY_BUFFER,coords,gl.STATIC_DRAW),gl.vertexAttribPointer(t.coordattrib,3,gl.FLOAT,!1,0,0),gl.enableVertexAttribArray(t.coordattrib),gl.bindBuffer(gl.ARRAY_BUFFER,t.tbuffer),gl.bufferData(gl.ARRAY_BUFFER,tcoords,gl.STATIC_DRAW),gl.vertexAttribPointer(t.texattrib,2,gl.FLOAT,!1,0,0),gl.enableVertexAttribArray(t.texattrib)}setShader(t){if(!t in shaders)throw"Unknown shader: "+t;this.shader=shaders[t],this.shader.program||this.shader.createProgram(gl)}prepareWebGL(e){e.useProgram(this.shader.program),this.ibuffer||(this.ibuffer=e.createBuffer(),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.ibuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,new Uint16Array([3,2,1,3,1,0]),e.STATIC_DRAW),this.vbuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.vbuffer),e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,0,0,1,0,1,1,0,1,0,0]),e.STATIC_DRAW),this.tbuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.tbuffer),e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,1,1,0]),e.STATIC_DRAW),this.coordattrib=e.getAttribLocation(this.program,"a_position"),e.vertexAttribPointer(t.coordattrib,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(this.coordattrib),this.texattrib=e.getAttribLocation(this.program,"a_texcoord"),e.vertexAttribPointer(t.texattrib,2,e.FLOAT,!1,0,0),e.enableVertexAttribArray(t.texattrib))}prefetch(t,e){"ready"==this.layout.status&&this.visible}}n.prototype.types={};e.Camera=s,e.Canvas=a,e.Layer=n,e.Layout=class{constructor(t,e){if(Object.assign(this,{width:0,height:0,tilesize:256,overlap:0,nlevels:1,ntiles:1,suffix:"jpg",qbox:[],bbox:[],ready:[],status:null}),"string"!=typeof t)"object"==typeof t&&Object.assign(this,t);else switch(callback=()=>{this.ntiles=initBoxes(),this.status="ready",this.emit("ready")},this.layout){case"image":this.initImage(callback);break;case"google":this.initGoogle(callback);break;case"deepzoom":this.initDeepzoom(callback)}}emit(t){for(let e of this[t])e(this)}index(t,e,i){for(var r=0,s=this.nlevels-1;s>t;s--)r+=this.qbox[s][2]*this.qbox[s][3];return r+i*this.qbox[t][2]+e}initBoxes(){this.qbox=[],this.bbox=[];for(var t=this.width,e=this.height,i=0,r=this.nlevels-1;r>=0;r--){var s=this.nlevels-1-r;this.qbox[s]=[0,0,0,0],this.bbox[s]=[0,0,t,e];for(var a=0;a*this.tilesize<e;a++){this.qbox[s][3]=a+1;for(var o=0;o*this.tilesize<t;o++)i++,this.qbox[s][2]=o+1}t>>>=1,e>>>=1}return i}tileCoords(e,i,r){var s=new Float32Array([0,0,0,0,1,0,1,1,0,1,0,0]),a=new Float32Array([0,0,0,1,1,1,1,0]);if("image"==t.layout)return{coords:s,tcoords:a};t.canvas.width,t.canvas.height;var o=this.tilesize*(1<<e),h=o,n=o;"google"!=this.layout&&(o*(i+1)>t.width&&(h=t.width-o*i),o*(r+1)>t.height&&(n=t.height-o*r));var l=this.qbox[e][2]-1,c=this.qbox[e][3]-1,d=this.overlap;if(d){var u=d/(h/(1<<e)+(0==i?0:d)+(i==l?0:d)),f=d/(n/(1<<e)+(0==r?0:d)+(r==c?0:d));a[0]=a[2]=0==i?0:u,a[1]=a[7]=0==r?0:f,a[4]=a[6]=i==l?1:1-u,a[3]=a[5]=r==c?1:1-f}return{coords:s,tcoords:a}}neededBox(t,e,i){if("image"==this.layout)return{level:0,box:[[0,0,1,1]]};for(var r=Math.max(0,Math.min(Math.floor(Math.log2(e.z)+this.mipmapbias),this.nlevels-1)),s=[],a=this.nlevels-1;a>=r;a--){var o=this.getIBox(t,e),h=this.tilesize*Math.pow(2,a),n=[Math.floor(o[0]/h),Math.floor(o[1]/h),Math.floor((o[2]-1)/h)+1,Math.floor((o[3]-1)/h)+1];n[0]=Math.max(n[0]-i,this.qbox[a][0]),n[1]=Math.max(n[1]-i,this.qbox[a][1]),n[2]=Math.min(n[2]+i,this.qbox[a][2]),n[3]=Math.min(n[3]+i,this.qbox[a][3]),s[a]=n}return{level:r,pyramid:s}}getTileURL(t,e,i,r){}loadImage(t,e,i,r,s){let a=this.getTileURL(t,e,i,r);(async()=>{var t=await fetch(a);if(!t.ok)return console.log(),void s("Failed loading "+a+": "+t.statusText);let e=await t.blob();if("undefined"!=typeof createImageBitmap){"undefined"!=typeof InstallTrigger?createImageBitmap(e).then(s):createImageBitmap(e,{imageOrientation:"flipY"}).then(s)}else{var i=window.URL||window.webkitURL,r=document.createElement("img");r.onerror=function(t){console.log("Texture loading error!")},r.src=i.createObjectURL(e),r.onload=function(){i.revokeObjectURL(r.src),s(r)}}})().catch((t=>{s(t)}))}initImage(){}initImage(t){this.nlevels=1,this.tilesize=0,this.qbox=[[0,0,1,1]],this.bbox=[[0,0,this.width,this.height]],t()}initGoogle(t){if(!this.width||!this.height)throw"Google rasters require to specify width and height";this.tilesize=256,this.overlap=0;let e=Math.max(this.width,this.height)/this.tilesize;this.nlevels=Math.ceil(Math.log(e)/Math.LN2)+1,this.getTileURL=(t,e,i)=>{var r=parseInt(this.nlevels-1-i);return this.url+"/"+r+"/"+e+"/"+t+"."+this.suffix},t()}initDeepzoom(t){(async()=>{var e=await fetch(this.url);if(!e.ok)return void(this.status="Failed loading "+this.url+": "+e.statusText);let i=await e.text(),r=(new window.DOMParser).parseFromString(i,"text/xml").documentElement;this.suffix=r.getAttribute("Format"),this.tilesize=r.getAttribute("TileSize"),this.overlap=r.getAttribute("Overlap");let s=r.querySelector("Size");this.width=s.getAttribute("Width"),this.height=s.getAttribute("Height");let a=Math.max(this.width,this.height)/this.tilesize;this.nlevels=Math.ceil(Math.log(a)/Math.LN2)+1,this.url=this.url.substr(0,this.url.lastIndexOf("."))+"_files/",this.getTileURL=(t,e,i)=>{let r=parseInt(this.nlevels-1-i);return this.url+r+"/"+t+"_"+e+"."+this.suffix},t()})().catch((t=>{console.log(t),this.status=t}))}initZoomify(){this.overlap=0,(async()=>{var e=await fetch(this.url);if(!e.ok)return void(this.status="Failed loading "+this.url+": "+e.statusText);await e.text();let i=e.split('"');this.tilesize=parseInt(i[11]);let r=Math.max(t.width,t.height)/t.tilesize;this.nlevels=Math.ceil(Math.log(r)/Math.LN2)+1,this.url=this.url.substr(0,this.url.lastIndexOf("/")),t.getTileURL=(t,e,i)=>{let r=parseInt(this.nlevels-1-i),s=this.index(i,t,e)>>>0>>8;return this.url+"/TileGroup"+s+"/"+r+"-"+t+"-"+e+"."+this.suffix},callback()})().catch((t=>{console.log(t),this.status=t}))}},e.OpenLIME=class{constructor(t,e){if("string"==typeof t&&(t=document.querySelector(t)),!t)throw"Missing element parameter";this.containerElement=t,this.canvasElement=t.querySelector("canvas"),this.canvasElement||(this.canvasElement=document.createElement("canvas"),t.appendChild(this.canvasElement)),this.canvasElement.addEventListener("resize",(t=>this.resize())),Object.assign(this,{background:[0,0,0,1]}),this.canvas=new a(this.canvasElement,this.canvas)}resize(t){console.log(t),redraw()}redraw(){this.animaterequest||(this.animaterequest=requestAnimationFrame((t=>{this.draw(t)})))}draw(t){console.log("drawing"),t||(t=performance.now()),this.animaterequest=null;let e=this.canvas.gl;e.viewport(0,0,this.canvas.width,this.canvas.height);var i=this.background;e.clearColor(i[0],i[1],i[2],i[3],i[4]),e.clear(e.COLOR_BUFFER_BIT),this.canvas.draw(t)||this.redraw()}},e.Raster=o,e.Shader=h,e.Transform=r,Object.defineProperty(e,"__esModule",{value:!0})}));
