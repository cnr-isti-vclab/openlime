!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("hammerjs")):"function"==typeof define&&define.amd?define(["exports","hammerjs"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).OpenLIME={},t.Hammer)}(this,(function(t,e){"use strict";class i{constructor(t){Object.assign(this,{x:0,y:0,z:1,a:0,t:0}),this.t||(this.t=performance.now()),"object"==typeof t&&Object.assign(this,t)}copy(){let t=new i;return Object.assign(t,this),t}apply(t,e){let i=this.rotate(t,e,this.a);return{x:i.x*this.z+this.x,y:i.y*this.z+this.y}}inverse(){let t=this.rotate(this.x,this.y,-this.a);return new i({x:-t.x,y:-t.y,z:1/this.z,a:-this.a,t:this.t})}rotate(t,e,i){return i=Math.PI*(i/180),{x:Math.cos(i)*t+Math.sin(i)*e,y:-Math.sin(i)*t+Math.cos(i)*e}}compose(t){let e=this.copy(),i=t;e.z*=i.z,e.a+=i.a;var s=this.rotate(e.x,e.y,i.a);return e.x=s.x*i.z+i.x,e.y=s.y*i.z+i.y,e}transformBox(t){let e=[1e20,1e20,-1e20,-1e20];for(let i=0;i<4;i++){let s=this.apply(t[0+(1&i)<<1],t[1+(2&i)]);e[0]=Math.min(s.x,e[0]),e[1]=Math.min(s.y,e[1]),e[2]=Math.max(s.x,e[2]),e[3]=Math.max(s.y,e[3])}return e}getInverseBox(t){let e=this.inverse(),i=[{x:t.x,y:t.y},{x:t.x+t.dx,y:t.y},{x:t.x,y:t.y+t.dy},{x:t.x+t.dx,y:t.y+t.dy}],s=[1e20,1e20,-1e20,-1e20];for(let r of i){let i=e.apply(r.x-t.w/2,r.y-t.h/2);s[0]=Math.min(i.x,s[0]),s[1]=Math.min(i.y,s[1]),s[2]=Math.max(i.x,s[2]),s[3]=Math.max(i.y,s[3])}return s}interpolate(t,e,i){if(i<t.t)return t;if(i>e.t)return e;let s=e.t-t.t;if(s<1e-4)return void Object.assign(this,e);let r=(i-t.t)/s,a=(e.t-i)/s;for(let i of["x","y","z","a"])this[i]=a*t[i]+r*e[i];this.t=i}projectionMatrix(t){let e=this.z,i=2*e/t.dx,s=2*e/t.dy,r=i*this.x+2/t.dx*(t.w/2-t.x)-1,a=-s*this.y+2/t.dy*(t.h/2-t.y)-1,n=Math.PI*this.a/180;return[Math.cos(n)*i,Math.sin(n)*s,0,0,-Math.sin(n)*i,Math.cos(n)*s,0,0,0,0,1,0,r,a,0,1]}toMatrix(){let t=this.z;return[t,0,0,0,0,t,0,0,0,0,1,0,t*x,t*y,0,1]}sceneToViewportCoords(t,e){return[(e[0]+this.x)*this.z-t.x+t.w/2,(e[1]-this.y)*this.z+t.y+t.h/2]}viewportToSceneCoords(t,e){return[(e[0]+t.x-t.w/2)/this.z-this.x,(e[1]-t.y-t.h/2)/this.z+this.y]}}class s{constructor(t){Object.assign(this,{viewport:null,bounded:!0,maxZoom:4,minZoom:"full",signals:{update:[]}}),Object.assign(this,t),this.target=new i(this.target),this.source=this.target.copy()}copy(){let t=new s;return Object.assign(t,this),t}addEvent(t,e){this.signals[t].push(e)}emit(t){for(let e of this.signals[t])e(this)}setViewport(t){this.viewport=t}mapToScene(t,e,i){return t-=this.viewport.w/2,e-=this.viewport.h/2,t/=i.z,e/=i.z,{x:t-=i.x,y:e-=i.y}}setPosition(t,e,i,s,r){let a=performance.now();this.source=this.getCurrentTransform(a),Object.assign(this.target,{x:e,y:i,z:s,a:r,t:a+t}),this.emit("update")}pan(t,e,i){let s=performance.now(),r=this.getCurrentTransform(s);r.dx+=e,r.dy+=i}zoom(t,e,i,s){i||(i=0),s||(s=0);let r=performance.now(),a=this.getCurrentTransform(r);a.x+=(a.x+i)*(a.z-e)/a.z,a.y+=(a.y+s)*(a.z-e)/a.z,this.setPosition(t,a.x,a.y,e,a.a)}deltaZoom(t,e,i,s){i||(i=0),s||(s=0);let r=performance.now(),a=this.getCurrentTransform(r);a.x+=(a.x+i)*(1-e),a.y+=(a.y+s)*(1-e),this.setPosition(t,a.x,a.y,this.target.z*e,a.a)}getCurrentTransform(t){if(t<this.source.t)return this.source.copy();if(t>=this.target.t)return this.target.copy();let e=new i;return e.interpolate(this.source,this.target,t),e}fit(t,e,i){e||(e=0);let s=this.viewport.dx,r=this.viewport.dy,a=t[2]-t[0],n=t[3]-t[1],h=Math.min(s/a,r/n);this.setPosition(e,(t[0]+t[2])/2,(t[1]+t[3])/2,h,0)}}class r{constructor(t,e,i){if(Object.assign(this,{preserveDrawingBuffer:!1,gl:t,camera:e,layers:{},signals:{update:[]}}),i){Object.assign(this,i);for(let t in this.layers)this.addLayer(t,new Layer(t,this.layers[t]))}}addEvent(t,e){this.signals[t].push(e)}emit(t){for(let e of this.signals[t])e(this)}addLayer(t,e){e.addEvent("update",(()=>{this.emit("update")})),e.gl=this.gl,this.layers[t]=e,this.prefetch()}draw(t){let e=this.gl,i=this.camera.viewport;e.viewport(i.x,i.y,i.dx,i.dy);var s=[0,1,0,1];e.clearColor(s[0],s[1],s[2],s[3],s[4]),e.clear(e.COLOR_BUFFER_BIT),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.enable(e.BLEND);let r=this.camera.getCurrentTransform(t);this.prefetch(r);let a=Object.values(this.layers).sort(((t,e)=>t.zindex-e.zindex)),n=!0;for(let t of a)t.visible&&(n=n&&t.draw(r,i));return n&&r.t==this.camera.target.t}prefetch(t){t||(t=this.camera.getCurrentTransform(performance.now()));for(let e in this.layers){let i=this.layers[e];i.visible&&i.prefetch(t,this.camera.viewport)}}}class a{constructor(t){Object.assign(this,{type:"vec3",colorSpace:"linear",attribute:"kd"}),Object.assign(this,t)}loadImage(t,e,i){(async()=>{var s=await fetch(t);if(!s.ok)return console.log(),void i("Failed loading "+t+": "+s.statusText);let r=await s.blob();if("undefined"!=typeof createImageBitmap){"undefined"!=typeof InstallTrigger?createImageBitmap(r).then((t=>this.loadTexture(e,t,i))):createImageBitmap(r,{imageOrientation1:"flipY"}).then((t=>this.loadTexture(e,t,i)))}else{var a=window.URL||window.webkitURL,n=document.createElement("img");n.onerror=function(t){console.log("Texture loading error!")},n.src=a.createObjectURL(r),n.onload=function(){a.revokeObjectURL(n.src),this.loadTexture(e,n,i)}}})().catch((t=>{i(null)}))}loadTexture(t,e,i){this.width=e.width,this.height=e.height;var s=t.createTexture();t.bindTexture(t.TEXTURE_2D,s),t.texParameterf(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameterf(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.RGB,t.RGB,t.UNSIGNED_BYTE,e),i(s,e.width*e.height*3)}}class n{constructor(t){Object.assign(this,{version:100,samplers:[],uniforms:{},name:"",body:"",program:null,needsUpdate:!0,signals:{update:[]}}),Object.assign(this,t)}setEvent(t,e){this.signals[t]=[e]}emit(t){for(let e of this.signals[t])e(this)}setUniform(t,e){let i=this.uniforms[t];i.value=e,i.needsUpdate=!0,this.emit("update")}createProgram(t){let e=t.createShader(t.VERTEX_SHADER);t.shaderSource(e,this.vertShaderSrc(100)),t.compileShader(e);let i=t.getShaderParameter(e,t.COMPILE_STATUS);if(!i)throw console.log(t.getShaderInfoLog(e)),Error("Failed vertex shader compilation: see console log and ask for support.");let s=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(s,this.fragShaderSrc()),t.compileShader(s),this.program&&t.deleteProgram(this.program);let r=t.createProgram();if(t.getShaderParameter(s,t.COMPILE_STATUS),i=t.getShaderParameter(s,t.COMPILE_STATUS),!i)throw console.log(this.fragShaderSrc()),console.log(t.getShaderInfoLog(s)),Error("Failed fragment shader compilation: see console log and ask for support.");if(t.attachShader(r,e),t.attachShader(r,s),t.linkProgram(r),!t.getProgramParameter(r,t.LINK_STATUS)){var a=t.getProgramInfoLog(r);throw new Error("Could not compile WebGL program. \n\n"+a)}for(let e of this.samplers)e.location=t.getUniformLocation(r,e.name);this.coordattrib=t.getAttribLocation(r,"a_position"),t.vertexAttribPointer(this.coordattrib,3,t.FLOAT,!1,0,0),t.enableVertexAttribArray(this.coordattrib),this.texattrib=t.getAttribLocation(r,"a_texcoord"),t.vertexAttribPointer(this.texattrib,2,t.FLOAT,!1,0,0),t.enableVertexAttribArray(this.texattrib),this.matrixlocation=t.getUniformLocation(r,"u_matrix"),this.program=r,this.needsUpdate=!1}updateUniforms(t,e){performance.now();for(const[i,s]of Object.entries(this.uniforms))if(s.location||(s.location=t.getUniformLocation(e,i)),s.location&&s.needsUpdate){let e=s.value;switch(s.type){case"vec4":t.uniform4fv(s.location,e);break;case"vec3":t.uniform3fv(s.location,e);break;case"vec2":t.uniform2fv(s.location,e);break;case"float":t.uniform1fv(s.location,e);break;case"int":t.uniform1i(s.location,e);break;default:throw Error("Unknown uniform type: "+u.type)}}}vertShaderSrc(){return"#version 300 es\n\nprecision highp float; \nprecision highp int; \n\nuniform mat4 u_matrix;\nin vec4 a_position;\nin vec2 a_texcoord;\n\nout vec2 v_texcoord;\n\nvoid main() {\n\tgl_Position = u_matrix * a_position;\n\tv_texcoord = a_texcoord;\n}"}fragShaderSrc(){return this.body}}class h{constructor(t,e,i){if(Object.assign(this,{type:e,width:1,height:1,tilesize:256,overlap:0,nlevels:1,tiles:[],suffix:"jpg",qbox:[],bbox:[],signals:{ready:[]},status:null}),i&&Object.assign(this,i),"string"!=typeof t)"object"==typeof t&&Object.assign(this,t);else{this.url=t;let e=()=>{this.initBoxes(),this.status="ready",this.emit("ready")};switch(this.type){case"image":this.initImage(this.width,this.height);break;case"google":this.initGoogle(e);break;case"deepzoom":this.initDeepzoom(e);break;case"zoomify":this.initZoomify(e)}}}addEvent(t,e){this.signals[t].push(e)}emit(t){for(let e of this.signals[t])e(this)}isReady(){return"ready"==this.status&&this.width&&this.height}boundingBox(){return[-this.width/2,-this.height/2,this.width/2,this.height/2]}index(t,e,i){let s=0;for(let e=0;e<t;e++)s+=this.qbox[e][2]*this.qbox[e][3];return s+i*this.qbox[t][2]+e}initBoxes(){this.qbox=[],this.bbox=[];var t=this.width,e=this.height;if("image"==this.type)return this.qbox[0]=[0,0,1,1],this.bbox[0]=[0,0,t,e],this.tiles.push({index:0,level:0,x:0,y:0}),1;let i=[];for(let s=this.nlevels-1;s>=0;s--){this.qbox[s]=[0,0,0,0],this.bbox[s]=[0,0,t,e];for(let r=0;r*this.tilesize<e;r++){this.qbox[s][3]=r+1;for(let e=0;e*this.tilesize<t;e++)this.qbox[s][2]=e+1,i.push({level:s,x:e,y:r})}t>>>=1,e>>>=1}this.tiles=[];for(let t of i){let e=this.index(t.level,t.x,t.y);t.index=e,this.tiles[e]=t}}tileCoords(t,e,i){let s=this.width,r=this.height;var a=new Float32Array([0,1,0,0,1,0,1,1]);if("image"==this.type)return{coords:new Float32Array([-s/2,-r/2,0,-s/2,r/2,0,s/2,r/2,0,s/2,-r/2,0]),tcoords:a};let n=new Float32Array([0,0,0,0,1,0,1,1,0,1,0,0]),h=this.nlevels-1-t,l=this.tilesize*(1<<h),o=l,c=l;l*(e+1)>this.width&&(o=this.width-l*e,"google"==this.type&&(a[4]=a[6]=o/l)),l*(i+1)>this.height&&(c=this.height-l*i,"google"==this.type&&(a[1]=a[7]=c/l));var d=this.qbox[t][2]-1,u=this.qbox[t][3]-1,m=this.overlap;if(m){let t=m/(o/(1<<h)+(0==e?0:m)+(e==d?0:m)),s=m/(c/(1<<h)+(0==i?0:m)+(i==u?0:m));a[0]=a[2]=0==e?0:t,a[3]=a[5]=0==i?0:s,a[4]=a[6]=e==d?1:1-t,a[1]=a[7]=i==u?1:1-s}let p=a[1];a[1]=a[7]=a[3],a[3]=a[5]=p;for(let t=0;t<n.length;t+=3)n[t]=n[t]*o+l*e-this.width/2,n[t+1]=-n[t+1]*c-l*i+this.height/2;return{coords:n,tcoords:a}}neededBox(t,e,i,s){if("image"==this.type)return{level:0,pyramid:[[0,0,1,1]]};let r=Math.max(0,Math.min(Math.floor(-Math.log2(e.z)+s),this.nlevels-1)),a=this.nlevels-1-r,n=e.getInverseBox(t);n[0]+=this.width/2,n[2]+=this.width/2,n[1]+=this.height/2,n[3]+=this.height/2;let h=[];for(let t=0;t<=a;t++){let e=this.nlevels-1-t,s=this.tilesize*Math.pow(2,e),r=[Math.floor(n[0]/s),Math.floor(n[1]/s),Math.floor((n[2]-1)/s)+1,Math.floor((n[3]-1)/s)+1];r[0]=Math.max(r[0]-i,this.qbox[t][0]),r[1]=Math.max(r[1]-i,this.qbox[t][1]),r[2]=Math.min(r[2]+i,this.qbox[t][2]),r[3]=Math.min(r[3]+i,this.qbox[t][3]),h[t]=r}return{level:a,pyramid:h}}getTileURL(t,e,i,s){throw Error("Layout not defined or ready.")}initImage(t,e){this.getTileURL=(t,e,i,s)=>t,this.nlevels=1,this.tilesize=0,t&&e&&(this.width=t,this.height=e,this.initBoxes(),this.status="ready",this.emit("ready"))}initGoogle(t){if(!this.width||!this.height)throw"Google rasters require to specify width and height";this.tilesize=256,this.overlap=0;let e=Math.max(this.width,this.height)/this.tilesize;this.nlevels=Math.ceil(Math.log(e)/Math.LN2)+1,this.getTileURL=(t,e,i,s)=>t+"/"+s+"/"+i+"/"+e+"."+this.suffix,t()}initDeepzoom(t){(async()=>{var e=await fetch(this.url);if(!e.ok)return void(this.status="Failed loading "+this.url+": "+e.statusText);let i=await e.text(),s=(new window.DOMParser).parseFromString(i,"text/xml").documentElement;this.suffix=s.getAttribute("Format"),this.tilesize=s.getAttribute("TileSize"),this.overlap=s.getAttribute("Overlap");let r=s.querySelector("Size");this.width=r.getAttribute("Width"),this.height=r.getAttribute("Height");let a=Math.max(this.width,this.height)/this.tilesize;this.nlevels=Math.ceil(Math.log(a)/Math.LN2)+1,this.url=this.url.substr(0,this.url.lastIndexOf("."))+"_files/",this.getTileURL=(t,e,i,s)=>(t=t.substr(0,t.lastIndexOf("."))+"_files/")+s+"/"+e+"_"+i+"."+this.suffix,t()})().catch((t=>{console.log(t),this.status=t}))}initZoomify(t){this.overlap=0,(async()=>{var e=await fetch(this.url);if(!e.ok)return void(this.status="Failed loading "+this.url+": "+e.statusText);let i=await e.text(),s=(new window.DOMParser).parseFromString(i,"text/xml").documentElement;if(this.tilesize=parseInt(s.getAttribute("TILESIZE")),this.width=parseInt(s.getAttribute("WIDTH")),this.height=parseInt(s.getAttribute("HEIGHT")),!this.tilesize||!this.height||!this.width)throw"Missing parameter files for zoomify!";let r=Math.max(this.width,this.height)/this.tilesize;this.nlevels=Math.ceil(Math.log(r)/Math.LN2)+1,this.url=this.url.substr(0,this.url.lastIndexOf("/")),this.getTileURL=(t,e,i,s)=>{let r=this.index(s,e,i)>>>0>>8;return t=t.substr(0,t.lastIndexOf("/")),this.url+"/TileGroup"+r+"/"+s+"-"+e+"-"+i+"."+this.suffix},t()})().catch((t=>{console.log(t),this.status=t}))}}let l=new class{constructor(t){Object.assign(this,{capacity:10485760,size:0,maxRequest:4,requested:0,maxPrefetch:8388608,prefetched:0}),Object.assign(this,t),this.layers=[]}setCandidates(t){this.layers.includes(t)||this.layers.push(t),setTimeout((()=>{this.update()}),0)}update(){if(this.requested>this.maxRequest)return;let t=this.findBestCandidate();if(t){for(;this.size>this.capacity;){let e=this.findWorstTile();if(!e){console.log("BIG problem in the cache");break}if(!(e.tile.time<t.tile.time))return;this.dropTile(e.layer,e.tile)}this.loadTile(t.layer,t.tile)}}findBestCandidate(){let t=null;for(let e of this.layers){if(!e.queue.length)continue;let i=e.queue.shift();(!t||i.time>t.tile.time||i.time==t.tile.time&&i.priority>t.tile.priority)&&(t={layer:e,tile:i})}return t}findWorstTile(){let t=null;for(let e of this.layers)for(let i of e.tiles)0==i.missing&&(!t||i.time<t.tile.time||i.time==t.tile.time&&i.priority<t.tile.priority)&&(t={layer:e,tile:i});return t}loadTile(t,e){this.requested++,t.loadTile(e,(t=>{this.size+=t,this.requested--,this.update()}))}dropTile(t,e){for(let i=0;i<e.tex.length;i++)e.tex[i]&&(t.gl.deleteTexture(e.tex[i]),e.tex[i]=null,e.missing++);this.size-=e.size,e.size=0}flush(){}flush(t){}};class o{constructor(t){if(Object.assign(this,{transform:new i,visible:!0,zindex:0,opacity:1,rasters:[],layers:[],controls:{},controllers:[],shaders:{},layout:"image",shader:null,gl:null,prefetchBorder:1,mipmapBias:.5,maxRequest:4,signals:{update:[],ready:[]},tiles:[],queue:[],requested:{}}),Object.assign(this,t),this.type){if(this.type in this.types)return t.type=null,this.types[this.type](t);throw"Layer type: "+this.type+" has not been loaded"}this.rasters=this.rasters.map((t=>new a(t))),this.transform=new i(this.transform),"object"!=typeof this.layout&&this.rasters.length&&this.setLayout(new h(this.rasters[0],this.layout)),this.shader&&(this.shader=new n(this.shader))}addEvent(t,e){this.signals[t].push(e)}emit(t){for(let e of this.signals[t])e(this)}setLayout(t){let e=()=>{this.status="ready",this.setupTiles(),this.emit("ready"),this.emit("update")};"ready"==t.status?e():t.addEvent("ready",e),this.layout=t}setShader(t){if(!t in this.shaders)throw"Unknown shader: "+t;this.shader=this.shaders[t],this.setupTiles(),this.shader.setEvent("update",(()=>{this.emit("update")}))}setVisible(t){this.visible=t,this.previouslyNeeded=null,this.emit("update")}setZindex(t){this.zindex=t,this.emit("update")}boundingBox(){return this.layout.boundingBox()}setControl(t,e,i){let s=performance.now(),r=this.controls[t];this.interpolateControl(r,s),r.source.value=[...r.current.value],r.source.t=s,r.target.value=[...e],r.target.t=s+i,this.emit("update")}interpolateControls(){let t=performance.now(),e=!0;for(let i of Object.values(this.controls))e=this.interpolateControl(i,t)&&e;return e}interpolateControl(t,e){let i=t.source,s=t.target,r=t.current;if(r.t=e,e<i.t)return r.value=[...i.value],!1;if(e>s.t-1e-4)return r.value=[...s.value],!0;let a=s.t-i.t,n=(e-i.t)/a,h=(s.t-e)/a;r.value=[];for(let t=0;t<i.value.length;t++)r.value[t]=h*i.value[t]+n*s.value[t];return!1}draw(t,e){if("ready"==!this.status||0==this.tiles.length)return;if(!this.shader)throw"Shader not specified!";let i=this.interpolateControls();this.prepareWebGL(),t=this.transform.compose(t);let s=this.layout.neededBox(e,t,this.prefetchBorder,this.mipmapBias),r=this.toRender(s),a=t.projectionMatrix(e);this.gl.uniformMatrix4fv(this.shader.matrixlocation,this.gl.FALSE,a);for(let t in r){r[t];this.drawTile(r[t])}return i}drawTile(t){let e=this.tiles[t.index];if(0!=e.missing)throw"Attempt to draw tile still missing textures";let i=this.layout.tileCoords(t.level,t.x,t.y);this.updateTileBuffers(i.coords,i.tcoords);let s=this.gl;for(var r=0;r<this.shader.samplers.length;r++){let t=this.shader.samplers[r].id;s.uniform1i(this.shader.samplers[r].location,r),s.activeTexture(s.TEXTURE0+r),s.bindTexture(s.TEXTURE_2D,e.tex[t])}s.drawElements(s.TRIANGLES,6,s.UNSIGNED_SHORT,0)}toRender(t){var e={},i={};let s=t.level;for(var r=t.pyramid[s],a=r[1];a<r[3];a++)for(var n=r[0];n<r[2];n++)for(var h=s;h>=0;){var l=s-h,o=this.layout.index(h,n>>l,a>>l);if(0==this.tiles[o].missing){e[o]={index:o,level:h,x:n>>l,y:a>>l,complete:!0};break}var c=n>>l+1<<1,d=a>>l+1<<1;i[this.layout.index(h,c,d)]=1,i[this.layout.index(h,c+1,d)]=1,i[this.layout.index(h,c+1,d+1)]=1,i[this.layout.index(h,c,d+1)]=1,h--}for(let t in i)t in e&&(e[t].complete=!1);return e}updateTileBuffers(t,e){let i=this.gl;i.bindBuffer(i.ARRAY_BUFFER,this.vbuffer),i.bufferData(i.ARRAY_BUFFER,t,i.STATIC_DRAW),i.vertexAttribPointer(this.shader.coordattrib,3,i.FLOAT,!1,0,0),i.enableVertexAttribArray(this.shader.coordattrib),i.bindBuffer(i.ARRAY_BUFFER,this.tbuffer),i.bufferData(i.ARRAY_BUFFER,e,i.STATIC_DRAW),i.vertexAttribPointer(this.shader.texattrib,2,i.FLOAT,!1,0,0),i.enableVertexAttribArray(this.shader.texattrib)}setupTiles(){if(this.shader&&this.layout&&"ready"==this.layout.status)if(this.tiles.length)for(let t of this.tiles){t.missing=this.shader.samplers.length;for(let e of this.shader.samplers)t.tex[e.id]&&t.missing--}else{this.tiles=JSON.parse(JSON.stringify(this.layout.tiles));for(let t of this.tiles)t.tex=new Array(this.shader.samplers.length),t.missing=this.shader.samplers.length,t.size=0}}prepareWebGL(){let t=this.gl;this.shader.needsUpdate&&this.shader.createProgram(t),t.useProgram(this.shader.program),this.shader.updateUniforms(t,this.shader.program),this.ibuffer||(this.ibuffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.ibuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array([3,2,1,3,1,0]),t.STATIC_DRAW),this.vbuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.vbuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,0,0,1,0,1,1,0,1,0,0]),t.STATIC_DRAW),this.tbuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.tbuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,1,1,0]),t.STATIC_DRAW))}sameNeeded(t,e){return t.level==e.level&&t.pyramid[t.level][0]==e.pyramid[t.level][0]&&t.pyramid[t.level][1]==e.pyramid[t.level][1]&&t.pyramid[t.level][2]==e.pyramid[t.level][2]&&t.pyramid[t.level][3]==e.pyramid[t.level][3]}prefetch(t,e){if(0!=this.layers.length)for(let i of this.layers)i.prefetch(t,e);if(0==this.rasters.length)return;if("ready"!=this.status)return;let i=this.layout.neededBox(e,t,this.prefetchBorder,this.mipmapBias);if(this.previouslyNeeded&&this.sameNeeded(this.previouslyNeeded,i))return;this.previouslyNeeded=i,this.queue=[];let s=performance.now();for(let t=0;t<=i.level;t++){let e=i.pyramid[t],r=[];for(let a=e[1];a<e[3];a++)for(let n=e[0];n<e[2];n++){let e=this.layout.index(t,n,a),h=this.tiles[e];h.time=s,h.priority=i.level-t,0==h.missing||this.requested[e]||r.push(h)}let a=(e[0]+e[2])/2,n=(e[1]+e[3])/2;r.sort((function(t,e){return Math.abs(t.x-a)+Math.abs(t.y-n)-Math.abs(e.x-a)-Math.abs(e.y-n)})),this.queue=this.queue.concat(r)}l.setCandidates(this)}loadTile(t,e){if(this.requested[t.index])throw"AAARRGGHHH double request!";this.requested[t.index]=!0;for(let i of this.shader.samplers){let s=this.layout.getTileURL(this.rasters[i.id].url,t.x,t.y,t.level),r=this.rasters[i.id];r.loadImage(s,this.gl,((s,a)=>{"image"==this.layout.type&&this.layout.initImage(r.width,r.height),t.size+=a,t.tex[i.id]=s,t.missing--,t.missing<=0&&(this.emit("update"),delete this.requested[t.index],e&&e(a))}))}}}o.prototype.types={};class c extends n{constructor(t){super(t),Object.assign(this,{modes:["light","normals","diffuse","specular"],mode:"normal",type:["ptm","hsh","rbf","bln"],colorspaces:["lrgb","rgb","mrgb","mycc"],nplanes:null,yccplanes:null,njpegs:null,material:null,lights:null,sigma:null,ndimensions:null,scale:null,bias:null,basis:null,lweights:null}),this.relight&&this.init(this.relight),this.setMode("light")}setMode(t){if(!this.modes.includes(t))throw Error("Unknown mode: "+t);this.mode=t,"light"!=t&&(this.lightWeights([.612,.354,.707],"base"),this.lightWeights([-.612,.354,.707],"base1"),this.lightWeights([0,-.707,.707],"base2")),this.body=this.template(),this.needsUpdate=!0}setLight(t){if(!this.uniforms.light)throw"Shader not initialized, wait on layer ready event for setLight.";let e=t[0],i=t[1],s=Math.sqrt(e*e+i*i);s>1&&(e/=s,i/=s),t=[e,i,Math.sqrt(Math.max(0,1-e*e-i*i))],"light"==this.mode&&this.lightWeights(t,"base"),this.setUniform("light",t)}init(t){for(Object.assign(this,t),"mycc"==this.colorspace?this.nplanes=this.yccplanes[0]+this.yccplanes[1]+this.yccplanes[2]:this.yccplanes=[0,0,0],this.planes=[],this.njpegs=0;3*this.njpegs<this.nplanes;)this.njpegs++;for(let t=0;t<this.njpegs;t++)this.samplers.push({id:t,name:"plane"+t,type:"vec3"});this.material=this.materials[0],this.lights&&(this.lights,new Float32Array(this.lights)),"rbf"==this.type&&(this.ndimensions=this.lights.length/3),"bilinear"==this.type&&(this.ndimensions=this.resolution*this.resolution,this.type="bln"),this.scale=this.material.scale,this.bias=this.material.bias,["mrgb","mycc"].includes(this.colorspace)&&this.loadBasis(this.basis),this.uniforms={light:{type:"vec3",needsUpdate:!0,size:3,value:[0,0,1]},bias:{type:"vec3",needsUpdate:!0,size:this.nplanes/3,value:this.bias},scale:{type:"vec3",needsUpdate:!0,size:this.nplanes/3,value:this.scale},base:{type:"vec3",needsUpdate:!0,size:this.nplanes},base1:{type:"vec3",needsUpdate:!1,size:this.nplanes},base2:{type:"vec3",needsUpdate:!1,size:this.nplanes}},this.lightWeights([0,0,1],"base"),this.body=this.template()}lightWeights(t,e,i){let s;switch(this.type){case"ptm":s=class{static lightWeights(t){let e=[1,t[0],t[1],t[0]*t[0],t[0]*t[1],t[1]*t[1]],i=new Float32Array(18);for(let t=0;t<18;t++)i[3*t]=i[3*t+1]=i[3*t+2]=e[t];return i}}.lightWeights(t);break;case"hsh":s=class{static lightWeights(t){let e=3.1415,i=Math.atan2(t[1],t[0]);i<0&&(i=2*e+i);let s=Math.min(Math.acos(t[2]),e/2-.5),r=Math.cos(i),a=Math.cos(s),n=a*a,h=[1/Math.sqrt(2*e),Math.sqrt(6/e)*(r*Math.sqrt(a-n)),Math.sqrt(3/(2*e))*(2*a-1),Math.sqrt(6/e)*(Math.sqrt(a-n)*Math.sin(i)),Math.sqrt(30/e)*(Math.cos(2*i)*(-a+n)),Math.sqrt(30/e)*(r*(2*a-1)*Math.sqrt(a-n)),Math.sqrt(5/(2*e))*(1-6*a+6*n),Math.sqrt(30/e)*((2*a-1)*Math.sqrt(a-n)*Math.sin(i)),Math.sqrt(30/e)*((-a+n)*Math.sin(2*i))],l=new Float32Array(27);for(let t=0;t<27;t++)l[3*t]=l[3*t+1]=l[3*t+2]=h[t];return l}}.lightWeights(t);break;case"rbf":s=d.lightWeights(t,this);break;case"bln":s=class{static lightWeights(t,e){let i=e.nplanes,s=Math.abs(t[0])+Math.abs(t[1])+Math.abs(t[2]),r=(t[0]+t[1])/s,a=(t[1]-t[0])/s;r=(r+1)/2,a=(a+1)/2,r*=e.resolution-1,a*=e.resolution-1;let n=Math.min(e.resolution-2,Math.max(0,Math.floor(r))),h=Math.min(e.resolution-2,Math.max(0,Math.floor(a))),l=r-n,o=a-h,c=(1-l)*(1-o),d=l*(1-o),u=(1-l)*o,m=l*o,p=new Float32Array(3*(i+1));for(let t=0;t<i+1;t++)for(let i=0;i<3;i++){let s=e.basePixelOffset(t,n,h,i),r=e.basePixelOffset(t,n+1,h,i),a=e.basePixelOffset(t,n,h+1,i),l=e.basePixelOffset(t,n+1,h+1,i);p[3*t+i]=c*e.basis[s]+d*e.basis[r]+u*e.basis[a]+m*e.basis[l]}return p}}.lightWeights(t,this)}this.setUniform(e,s,i)}baseLightOffset(t,e,i){return 3*(t*this.ndimensions+e)+i}basePixelOffset(t,e,i,s){return 3*(t*this.resolution*this.resolution+(e+i*this.resolution))+s}loadBasis(t){let e=new Uint8Array(t);this.basis=new Float32Array(t.length);for(let t=0;t<this.nplanes+1;t++)for(let i=0;i<this.ndimensions;i++)for(let s=0;s<3;s++){let r=this.baseLightOffset(t,i,s);this.basis[r]=0==t?e[r]/255:(e[r]-127)/this.material.range[t-1]}}template(){let t=`#version 300 es\n\nprecision highp float; \nprecision highp int; \n\n#define np1 ${this.nplanes+1}\n\nin vec2 v_texcoord;\nout vec4 color;\n\nconst mat3 T = mat3(8.1650e-01, 4.7140e-01, 4.7140e-01,\n\t-8.1650e-01, 4.7140e-01,  4.7140e-01,\n\t-1.6222e-08, -9.4281e-01, 4.7140e-01);\n\nuniform vec3 light;\nuniform vec3 bias[np1];\nuniform vec3 scale[np1];\n\nuniform vec3 base[np1];\nuniform vec3 base1[np1];\nuniform vec3 base2[np1];\n`;for(let e=0;e<this.njpegs;e++)t+=`uniform sampler2D plane${e};\n`;switch("mycc"==this.colorspace&&(t+=`\n\nconst int ny0 = ${this.yccplanes[0]};\nconst int ny1 = ${this.yccplanes[1]};\n`),this.colorspace){case"rgb":t+=class{static render(t){let e="\nvec4 render(vec3 base[np1]) {\n\tvec4 rgb = vec4(0, 0, 0, 1);";for(let i=0;i<t;i++)e+=`\n\t{\n\t\tvec4 c = texture(plane${i}, v_texcoord);\n\t\trgb.x += base[${i}].x*(c.x - bias[${i}].x)*scale[${i}].x;\n\t\trgb.y += base[${i}].y*(c.y - bias[${i}].y)*scale[${i}].y;\n\t\trgb.z += base[${i}].z*(c.z - bias[${i}].z)*scale[${i}].z;\n\t}\n`;return e+="\n\treturn rgb;\n}\n",e}}.render(this.njpegs);break;case"mrgb":t+=class{static render(t){let e="\nvec4 render(vec3 base[np1]) {\n\tvec3 rgb = base[0];\n\tvec4 c;\n";for(let i=0;i<t;i++)e+=`\tc = texture(plane${i}, v_texcoord);\n\trgb += base[${i}*3+1]*(c.x - bias[${i}].x)*scale[${i}].x;\n\trgb += base[${i}*3+2]*(c.y - bias[${i}].y)*scale[${i}].y;\n\trgb += base[${i}*3+3]*(c.z - bias[${i}].z)*scale[${i}].z;\n\n`;return e+="\n\treturn vec4(rgb, 1);\n}\n",e}}.render(this.njpegs)}if(t+="\n\nvoid main(void) {\n\n","light"==this.mode)t+="\n\tcolor = render(base);\n";else switch(t+="\n\tvec3 normal;\n\tnormal.x = dot(render(base).xyz, vec3(1));\n\tnormal.y = dot(render(base1).xyz, vec3(1));\n\tnormal.z = dot(render(base2).xyz, vec3(1));\n",this.mode){case"normals":t+="\n\tnormal = (normalize(T * normal) + 1.0)/2.0;\n\tcolor = vec4(normal, 1);\n";break;case"diffuse":t+="\n\tnormal = normalize(T * normal);\n\tcolor = vec4(vec3(dot(light, normal)), 1);\n"}return t+="\n}",t}}class d{static lightWeights(t,e){let i=d.rbf(t,e),s=e.nplanes,r=new Float32Array(3*(s+1));for(let t=0;t<s+1;t++)for(let s=0;s<3;s++)for(let a=0;a<i.length;a++){let n=e.baseLightOffset(t,i[a][0],s);r[3*t+s]+=i[a][1]*e.basis[n]}return r}static rbf(t,e){let i=1/(e.sigma*e.sigma),s=new Array(e.ndimensions),r=0;for(let a=0;a<s.length;a++){let n=e.lights[3*a+0]-t[0],h=e.lights[3*a+1]-t[1],l=e.lights[3*a+2]-t[2],o=n*n+h*h+l*l,c=Math.exp(-i*o);s[a]=[a,c],r+=c}for(let t=0;t<s.length;t++)s[t][1]/=r;let a=0;r=0;for(let t=0;t<s.length;t++)s[t][1]>.001&&(s[a++]=s[t],r+=s[t][1]);s=s.slice(0,a);for(let t=0;t<s.length;t++)s[t][1]/=r;return s}}class m{constructor(t){Object.assign(this,{active:!0,debug:!1,delay:100}),Object.assign(this,t)}captureEvents(){this.capture=!0}releaseEvents(){this.capture=!1}}class p extends m{constructor(t,e){super(e),this.callback=t,e&&e.box||(this.box=[-.99,-.99,.99,.99]),this.panning=!1}update(t,e,i){t=Math.max(0,Math.min(1,t/i.width)),e=Math.max(0,Math.min(1,1-e/i.height)),t=this.box[0]+t*(this.box[2]-this.box[0]),e=this.box[1]+e*(this.box[3]-this.box[1]),this.callback(t,e)}panStart(t,e,i){return this.update(e,i,t.rect),this.panning=!0,!0}panMove(t,e,i){return!!this.panning&&(this.update(e,i,t.rect),!0)}panEnd(t,e,i){return!!this.panning&&(this.panning=!1,!0)}singleTap(t,e,i){return this.update(e,i,t.rect),!0}}class f extends o{constructor(t){if(super(t),0!=Object.keys(this.rasters).length)throw"Rasters options should be empty!";if(!this.url)throw"Url option is required";this.layout||(this.layout="image"),this.shaders.rti=new c,this.setShader("rti");let e=performance.now();this.controls.light={source:{value:[0,0],t:e},target:{value:[0,0],t:e},current:{value:[0,0],t:e}},this.url&&this.init(this.url)}planeUrl(t,e){let i=this.url.split("/").slice(0,-1).join("/")+"/";switch(this.layout){case"image":return i+"plane_"+e+".jpg";case"google":return i+"plane_"+e;case"deepzoom":return i+"plane_"+e+".dzi";case"zoomify":return i+"plane_"+e+"/ImageProperties.xml";case"iip":case"iiif":throw Error("Unimplemented");default:throw Error("Unknown layout: "+layout)}}setLight(t,e){this.setControl("light",t,e)}init(t){(async()=>{var t=await fetch(this.url);if(!t.ok)return void(this.status="Failed loading "+this.url+": "+t.statusText);let e=await t.json();this.shader.init(e);for(let t=0;t<this.shader.njpegs;t++)this.rasters.push(new a({url:this.planeUrl(this.url,t),type:"vec3",attribute:"coeff",colorspace:"linear"}));let i={width:this.width,height:this.height};this.setLayout(new h(this.planeUrl(this.url,0),this.layout,i));let s=new p(((t,e)=>this.setControl("light",[t,e],100)),{active:!1,control:"light"});this.controllers.push(s)})().catch((t=>{console.log(t),this.status=t}))}interpolateControls(){let t=super.interpolateControls();if(!t){let t=this.controls.light.current.value;this.shader.setLight(t)}return t}}o.prototype.types.rti=t=>new f(t);class g extends m{constructor(t,e){super(e),this.camera=t,this.zoomAmount=1.2,this.panning=!1,this.zooming=!1,this.startPosition=null,this.startMouse=null,this.prevScale=1}panStart(t,e,i){this.panning=!0,this.startMouse={x:e,y:i};let s=performance.now();this.startPosition=this.camera.getCurrentTransform(s),this.camera.target=this.startPosition.copy()}panMove(t,e,i){if(!this.panning)return;let s=e-this.startMouse.x,r=i-this.startMouse.y,a=this.startPosition.z,n=this.startPosition.x+s/a,h=this.startPosition.y+r/a,l=this.startPosition.a;this.camera.setPosition(this.delay,n,h,a,l)}panEnd(t,e,i){this.panning=!1}pinchStart(t,e,i,s){this.zooming=!0,this.prevScale=s}pinchMove(t,e,i,s){if(!this.zooming)return;const r=this.camera.mapToScene(e,i,this.camera.getCurrentTransform(performance.now())),a=camera.target.z*this.prevScale/s;this.camera.zoom(this.delay,a,r.x,r.y),this.prevScale=s}pinchEnd(t,e,i,s){this.zooming=!1}wheelDelta(t,e,i,s){const r=this.camera.mapToScene(e,i,this.camera.getCurrentTransform(performance.now())),a=Math.pow(this.zoomAmount,s);this.camera.deltaZoom(this.delay,a,r.x,r.y)}doubleTap(t,e,i){const s=this.camera.mapToScene(e,i,this.camera.getCurrentTransform(performance.now())),r=this.zoomAmount;this.camera.deltaZoom(this.delay,r,s.x,s.y)}}t.Camera=s,t.Canvas=r,t.Layer=o,t.Layout=h,t.OpenLIME=class{constructor(t,e){if(Object.assign(this,{background:[0,0,0,1],canvas:{},overlay:{},controllers:[],camera:new s}),"string"==typeof t&&(t=document.querySelector(t)),!t)throw"Missing element parameter";this.containerElement=t,this.canvasElement=t.querySelector("canvas"),this.canvasElement||(this.canvasElement=document.createElement("canvas"),t.prepend(this.canvasElement)),this.initCanvasElement(this.canvasElement),this.overlayElement=document.createElement("div"),this.overlayElement.classList.add("openlime-overlay"),this.containerElement.appendChild(this.overlayElement),this.canvas=new r(this.gl,this.camera,this.canvas),this.canvas.addEvent("update",(()=>{this.redraw()})),this.camera.addEvent("update",(()=>{this.redraw()})),this.controllers.push(new g(this.camera)),new ResizeObserver((t=>{for(let e of t)this.resize(e.contentRect.width,e.contentRect.height),this.processEvent("resize",{},e.contentRect.width,e.contentRect.height)})).observe(this.canvasElement),this.resize(this.canvasElement.clientWidth,this.canvasElement.clientHeight),this.initEvents()}initCanvasElement(t){if(!t)throw"Missing element parameter";if("string"==typeof t&&!(t=document.querySelector(t)))throw"Could not find dom element.";if(!t.tagName)throw"Element is not a DOM element";if("CANVAS"!=t.tagName)throw"Element is not a canvas element";let e={antialias:!1,depth:!1,preserveDrawingBuffer:this.preserveDrawingBuffer};if(this.gl=this.gl||t.getContext("webgl2",e)||t.getContext("webgl",e)||t.getContext("experimental-webgl",e),!this.gl)throw"Could not create a WebGL context"}resize(t,e){this.canvasElement.width=t,this.canvasElement.height=e,this.camera.setViewport({x:0,y:0,dx:t,dy:e,w:t,h:e}),this.canvas.prefetch(),this.redraw()}redraw(){this.animaterequest||(this.animaterequest=requestAnimationFrame((t=>{this.draw(t)})))}draw(t){t||(t=performance.now()),this.animaterequest=null;let e=this.camera.viewport,i=this.camera.getCurrentTransform(t),s=this.canvas.draw(t);for(let[t,r]of Object.values(this.overlay))s&=r.draw(i,e);s||this.redraw()}processEvent(t,e,i,s,r){let a=Object.values(this.canvas.layers).sort(((t,e)=>e.zindex-t.zindex));a.push(this);for(let n of a)for(let a of n.controllers)if(a.active&&a[t]&&a[t](e,i,s,r))return}hammerEventToPosition(t){let e=this.canvasElement.getBoundingClientRect(),i=t.center.x-e.left,s=t.center.y-e.top;return t.rect=e,{x:i,y:s}}eventToPosition(t,e){let i=t.currentTarget.getBoundingClientRect(),s=t.clientX-i.left,r=t.clientY-i.top;return t.rect=i,{x:s,y:r}}initEvents(){let t=this.canvasElement;t.addEventListener("contextmenu",(t=>(t.preventDefault(),!1)));const i=new e.Manager(t);i.add(new e.Tap({event:"doubletap",taps:2})),i.add(new e.Tap({event:"singletap",taps:1})),i.get("doubletap").recognizeWith("singletap"),i.get("singletap").requireFailure("doubletap"),i.add(new e.Pan({pointers:1,direction:e.DIRECTION_ALL,threshold:0})),i.add(new e.Pinch);let s={singletap:"singleTap",doubletap:"doubleTap",panstart:"panStart",panmove:"panMove","panend pancancel":"panEnd",pinchstart:"pinchStart",pinchmove:"pinchMove","pinchend pinchcancel":"pinchEnd"};for(let[t,e]of Object.entries(s))i.on(t,(t=>{const i=this.hammerEventToPosition(t),s=t.scale;return this.processEvent(e,t,i.x,i.y,s),t.preventDefault(),!1}));t.addEventListener("wheel",(t=>{const e=this.eventToPosition(t);let i=t.deltaY>0?1:-1;this.processEvent("wheelDelta",t,e.x,e.y,i),t.preventDefault()}))}},t.RTILayer=f,t.Raster=a,t.Shader=n,t.Transform=i,t.UIBasic=class{constructor(t,e){t.canvas.addEvent("update",(()=>{this.updateLayers()}));let i=t.camera;Object.assign(this,{lime:t,camera:this.camera,skin:"skin.svg",style:"skin.css",actions:{home:{title:"Home",task:t=>{this.ready&&i.fit(this.viewport,250)}},layers:{title:"Layers",task:t=>{this.selectLayers(t)}},zoomin:{title:"Zoom in",task:t=>{this.ready&&i.deltaZoom(250,1.25,0,0)}},zoomout:{title:"Zoom out",task:t=>{this.ready&&i.deltaZoom(250,.8,0,0)}},light:{title:"Light",task:t=>{this.toggleLightController()}},fullscreen:{title:"Fullscreen",task:t=>{this.toggleFullscreen()}}},viewport:[0,0,0,0]}),e&&Object.assign(this,e),this.init()}init(){(async()=>{this.skin&&await this.loadSkin(),this.setupActions();for(let t of Object.values(this.lime.canvas.layers)){this.setLayer(t);break}})().catch((t=>{throw console.log(t),Error("Something failed")}))}updateLayers(){this.ready=!0;let t=[1e20,1e20,-1e20,-1e20];for(let e of Object.values(this.lime.canvas.layers)){if("ready"!=e.status){this.ready=!1;continue}let i=e.transform.transformBox(e.boundingBox());t[0]=Math.min(i[0],t[0]),t[1]=Math.min(i[1],t[1]),t[2]=Math.max(i[2],t[2]),t[3]=Math.max(i[3],t[3])}t[2]>t[0]&&(this.viewport=t)}async loadSkin(){var t=await fetch(this.skin);if(!t.ok)throw Error("Failed loading "+url+": "+t.statusText);let e=await t.text(),i=(new DOMParser).parseFromString(e,"image/svg+xml").documentElement,s=document.createElement("div");s.classList.add("openlime-toolbar"),this.lime.containerElement.appendChild(s);{let t=document.createElementNS("http://www.w3.org/2000/svg","svg");s.appendChild(t);let e=10,r=e,a=0;for(let[s,n]of Object.entries(this.actions)){let n=i.querySelector(".openlime-"+s).cloneNode(!0);if(!n)continue;t.appendChild(n);let h=n.getBBox();a=Math.max(a,h.height);let l=n.transform.baseVal;0==l.numberOfItems&&l.appendItem(t.createSVGTransform()),l.getItem(0).setTranslate(-h.x+r,-h.y),r+=h.width+e}Object.assign(t.viewBox.baseVal,{x:0,y:0,width:r,height:a})}}setupActions(){for(let[t,e]of Object.entries(this.actions)){let i=this.lime.containerElement.querySelector(".openlime-"+t);i&&i.addEventListener("click",e.task)}let t=document.querySelectorAll(".openlime-layers-button");for(let e of t){let t=e.getAttribute("data-layer");t&&e.addEventListener("click",(()=>{this.setLayer(this.lime.layers[t])}))}}toggleLightController(){let t=this.lime.containerElement.classList.toggle("openlime-light-active");this.lightActive=t;for(let e of this.activeLayer.controllers)"light"==e.control&&(e.active=t)}toggleFullscreen(){let t=this.lime.canvasElement,e=this.lime.containerElement;e.classList.toggle("openlime-fullscreen-active")?(e.requestFullscreen||e.webkitRequestFullscreen||e.mozRequestFullScreen||e.msRequestFullscreen).call(e):((document.exitFullscreen||document.webkitExitFullscreen||document.mozCancelFullScreen||document.msExitFullscreen).call(document),this.lime.resize(t.offsetWidth,t.offsetHeight));this.lime.resize(t.offsetWidth,t.offsetHeight)}selectLayers(t){if(!this.layerMenu){let t=document.createElement("ul");t.classList.add("openlime-layers-menu");for(let[e,i]of Object.entries(this.lime.canvas.layers)){let s=document.createElement("li");s.innerHTML=i.label||e,s.addEventListener("click",(()=>{this.setLayer(i),this.closeLayersMenu()})),t.appendChild(s)}this.lime.containerElement.appendChild(t),this.layerMenu=t}this.layerMenu.style.left=t.offsetX+"px",this.layerMenu.style.top=t.offsetY+"px",this.layerMenu.style.display="block"}setLayer(t){this.activeLayer=t;for(let e of Object.values(this.lime.canvas.layers)){e.setVisible(e==t);for(let i of e.controllers)"light"==i.control&&(i.active=this.lightActive&&e==t)}this.lime.redraw()}closeLayersMenu(){this.layerMenu.style.display="none"}},Object.defineProperty(t,"__esModule",{value:!0})}));
